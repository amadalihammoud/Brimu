# üê≥ Dockerfile para Backend do Brimu
# Multi-stage build para otimizar tamanho da imagem

# Stage 1: Build
FROM node:18-alpine AS builder

LABEL maintainer="Equipe Brimu"
LABEL description="Backend API do sistema Brimu - Gest√£o para Servi√ßos Arb√≥reos"
LABEL version="1.0.0"

# Instalar depend√™ncias do sistema
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    git \
    && rm -rf /var/cache/apk/*

# Definir diret√≥rio de trabalho
WORKDIR /app

# Copiar arquivos de depend√™ncias
COPY package*.json ./
COPY tsconfig.json ./

# Instalar depend√™ncias (incluindo devDependencies para build)
RUN npm ci --include=dev

# Copiar c√≥digo fonte
COPY src/ ./src/
COPY scripts/ ./scripts/

# Build da aplica√ß√£o
RUN npm run build

# Limpar devDependencies
RUN npm prune --production

# Stage 2: Production
FROM node:18-alpine AS production

# Instalar depend√™ncias de runtime necess√°rias
RUN apk add --no-cache \
    tini \
    curl \
    && rm -rf /var/cache/apk/*

# Criar usu√°rio n√£o-root para seguran√ßa
RUN addgroup -g 1001 -S nodejs \
    && adduser -S backend -u 1001

# Definir diret√≥rio de trabalho
WORKDIR /app

# Copiar arquivos do stage de build
COPY --from=builder --chown=backend:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=backend:nodejs /app/dist ./dist
COPY --from=builder --chown=backend:nodejs /app/package*.json ./

# Criar diret√≥rios necess√°rios
RUN mkdir -p storage/logs storage/temp storage/backups uploads public \
    && chown -R backend:nodejs storage uploads public

# Copiar arquivos de configura√ß√£o
COPY --chown=backend:nodejs .env.example .env

# Definir vari√°veis de ambiente
ENV NODE_ENV=production
ENV PORT=5000
ENV LOG_LEVEL=info

# Expor porta
EXPOSE 5000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:5000/api/health || exit 1

# Mudar para usu√°rio n√£o-root
USER backend

# Usar tini como init process para gerenciar sinais
ENTRYPOINT ["/sbin/tini", "--"]

# Comando padr√£o
CMD ["node", "dist/app.js"]

# Metadata
LABEL org.opencontainers.image.title="Brimu Backend"
LABEL org.opencontainers.image.description="Backend API do sistema Brimu"
LABEL org.opencontainers.image.version="1.0.0"
LABEL org.opencontainers.image.vendor="Equipe Brimu"
LABEL org.opencontainers.image.licenses="MIT"